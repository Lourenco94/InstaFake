<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grupo</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #fafafa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .chat-container {
        width: 400px;
        height: 600px;
        background: #fff;
        border: 1px solid #dbdbdb;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      header {
        background: #fff;
        padding: 15px;
        border-bottom: 1px solid #dbdbdb;
        text-align: center;
        font-weight: bold;
        color: #262626;
      }

      #mensagens {
        list-style: none;
        flex: 1;
        margin: 0;
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .mensagem {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 80%;
        animation: aparecer 0.2s ease-in-out;
      }

      @keyframes aparecer {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .mensagem img.perfil {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
      }

      .bolha {
        background: #f0f0f0;
        padding: 10px 14px;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .mensagem.eu {
        align-self: flex-end;
        flex-direction: row-reverse;
      }

      .mensagem.eu .bolha {
        background: #0095f6;
        color: #fff;
      }

      .imagem-chat {
        max-width: 200px;
        border-radius: 10px;
        margin-top: 5px;
      }

      .nome-usuario {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 3px;
        color: #555;
      }

      .mensagem.eu .nome-usuario {
        text-align: right;
        color: #e4e4e4;
      }

      form {
        display: flex;
        flex-direction: column;
        padding: 10px;
        border-top: 1px solid #dbdbdb;
        background: #fff;
      }

      .perfil-section {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 10px;
      }

      input,
      button {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-size: 14px;
      }

      button {
        background: #0095f6;
        color: #fff;
        cursor: pointer;
        border: none;
        transition: 0.2s;
      }

      button:hover {
        background: #007acc;
      }

      .file-input {
        display: none;
      }

      .chat-input {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
      }

      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #0095f6;
      }

      #digitando {
        font-size: 12px;
        color: #888;
        margin-left: 10px;
        height: 16px;
      }

      /* Painel de emojis */
      .emoji-picker {
        position: absolute;
        bottom: 45px;
        left: 10px;
        background: #fff;
        border: 1px solid #dbdbdb;
        border-radius: 10px;
        padding: 5px;
        display: none;
        flex-wrap: wrap;
        width: 220px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-height: 120px;
        overflow-y: auto;
        z-index: 10;
      }

      .emoji-picker span {
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.1s;
      }

      .emoji-picker span:hover {
        transform: scale(1.2);
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <header>Grupo do Baseado</header>
      <ul id="mensagens"></ul>
      <div id="digitando"></div>

      <form id="form">
        <div class="perfil-section" id="perfilSection">
          <input
            id="nome"
            placeholder="Seu nome de usuÃ¡rio"
            autocomplete="off"
            required
          />
          <input
            type="file"
            id="fotoPerfil"
            accept="image/*"
            class="file-input"
          />
          <label for="fotoPerfil" style="cursor: pointer; color: #0095f6"
            >ğŸ“¸ Escolher foto de perfil</label
          >
          <button type="button" id="confirmarPerfil">Entrar</button>
        </div>

        <div id="chatSection" style="display: none">
          <div class="chat-input">
            <button type="button" class="icon-btn" id="emojiBtn">ğŸ˜Š</button>

            <div class="emoji-picker" id="emojiPicker">
              <span>ğŸ˜€</span><span>ğŸ˜</span><span>ğŸ˜‚</span><span>ğŸ¤£</span><span>ğŸ˜…</span><span>ğŸ˜</span>
              <span>ğŸ˜˜</span><span>ğŸ˜</span><span>ğŸ˜œ</span><span>ğŸ˜¡</span><span>ğŸ˜¢</span><span>ğŸ˜­</span>
              <span>ğŸ¤”</span><span>ğŸ™„</span><span>ğŸ˜´</span><span>ğŸ˜‡</span><span>ğŸ¤¯</span><span>ğŸ’€</span>
              <span>ğŸ‘€</span><span>ğŸ‘‹</span><span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ”¥</span><span>â¤ï¸</span>
              <span>ğŸ’©</span><span>ğŸŒˆ</span><span>ğŸŒ</span><span>ğŸ€</span><span>ğŸ•</span><span>ğŸ‰</span>
            </div>

            <input
              id="mensagem"
              placeholder="Digite uma mensagem..."
              autocomplete="off"
            />
            <input type="file" id="imagem" accept="image/*" class="file-input" />
            <button type="button" class="icon-btn" id="cameraBtn">ğŸ“¸</button>
            <button type="submit">Enviar</button>
          </div>
        </div>
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const mensagens = document.getElementById("mensagens");
      const nomeInput = document.getElementById("nome");
      const mensagemInput = document.getElementById("mensagem");
      const imagemInput = document.getElementById("imagem");
      const fotoPerfilInput = document.getElementById("fotoPerfil");
      const confirmarPerfilBtn = document.getElementById("confirmarPerfil");
      const perfilSection = document.getElementById("perfilSection");
      const chatSection = document.getElementById("chatSection");
      const form = document.getElementById("form");
      const cameraBtn = document.getElementById("cameraBtn");
      const emojiBtn = document.getElementById("emojiBtn");
      const emojiPicker = document.getElementById("emojiPicker");
      const digitandoDiv = document.getElementById("digitando");

      let nomeUsuario = "";
      let fotoPerfil = "";
      let typingTimeout;

      confirmarPerfilBtn.addEventListener("click", async () => {
        nomeUsuario = nomeInput.value.trim();
        if (!nomeUsuario) return alert("Digite um nome primeiro!");
        if (fotoPerfilInput.files[0]) {
          const reader = new FileReader();
          reader.onload = () => {
            fotoPerfil = reader.result;
            perfilSection.style.display = "none";
            chatSection.style.display = "flex";
          };
          reader.readAsDataURL(fotoPerfilInput.files[0]);
        } else {
          perfilSection.style.display = "none";
          chatSection.style.display = "flex";
        }
      });

      cameraBtn.addEventListener("click", () => imagemInput.click());

      // abrir e fechar o seletor de emojis
      emojiBtn.addEventListener("click", () => {
        emojiPicker.style.display =
          emojiPicker.style.display === "flex" ? "none" : "flex";
      });

      // adicionar emoji ao campo de texto
      emojiPicker.addEventListener("click", (e) => {
        if (e.target.tagName === "SPAN") {
          mensagemInput.value += e.target.textContent;
          mensagemInput.focus();
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const mensagem = mensagemInput.value.trim();
        let imagemBase64 = "";

        if (imagemInput.files[0]) {
          const reader = new FileReader();
          reader.onload = () => {
            imagemBase64 = reader.result;
            enviarMensagem(mensagem, imagemBase64);
            imagemInput.value = "";
          };
          reader.readAsDataURL(imagemInput.files[0]);
        } else {
          enviarMensagem(mensagem, imagemBase64);
        }
        mensagemInput.value = "";
        emojiPicker.style.display = "none";
      });

      function enviarMensagem(mensagem, imagemBase64) {
        if (!mensagem && !imagemBase64) return;
        socket.emit("chat message", {
          nome: nomeUsuario,
          foto: fotoPerfil,
          mensagem,
          imagem: imagemBase64,
        });
      }

      mensagemInput.addEventListener("input", () => {
        socket.emit("digitando", nomeUsuario);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit("parou digitar"), 1000);
      });

      socket.on("digitando", (nome) => {
        digitandoDiv.textContent = `${nome} estÃ¡ digitando...`;
      });

      socket.on("parou digitar", () => {
        digitandoDiv.textContent = "";
      });

      socket.on("chat message", (dados) => {
        const msg = document.createElement("li");
        msg.classList.add("mensagem");
        if (dados.nome === nomeUsuario) msg.classList.add("eu");

        const foto = document.createElement("img");
        foto.src = dados.foto || "https://via.placeholder.com/35";
        foto.classList.add("perfil");

        const bolha = document.createElement("div");
        bolha.classList.add("bolha");

        const nomeEl = document.createElement("div");
        nomeEl.classList.add("nome-usuario");
        nomeEl.textContent = dados.nome;

        const texto = document.createElement("div");
        texto.textContent = dados.mensagem;

        bolha.appendChild(nomeEl);
        bolha.appendChild(texto);

        if (dados.imagem) {
          const img = document.createElement("img");
          img.src = dados.imagem;
          img.classList.add("imagem-chat");
          bolha.appendChild(img);
        }

        msg.appendChild(foto);
        msg.appendChild(bolha);
        mensagens.appendChild(msg);
        mensagens.scrollTop = mensagens.scrollHeight;
      });
    </script>
  </body>
</html>

